name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v3

      - name: Configurar Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # ============================
      # CREAR .ENV DEL BACKEND
      # ============================
      - name: Crear archivo .env para backend
        run: |
          echo "PORT=4000" >> ./backend/.env
          echo "DB_HOST=${{ secrets.BACKEND_DB_HOST }}" >> ./backend/.env
          echo "DB_USER=${{ secrets.BACKEND_DB_USER }}" >> ./backend/.env
          echo "DB_PASSWORD=${{ secrets.BACKEND_DB_PASSWORD }}" >> ./backend/.env
          echo "DB_NAME=${{ secrets.BACKEND_DB_NAME }}" >> ./backend/.env
          echo "MAIL_HOST=${{ secrets.BACKEND_MAIL_HOST }}" >> ./backend/.env
          echo "MAIL_PORT=${{ secrets.BACKEND_MAIL_PORT }}" >> ./backend/.env
          echo "FRONTEND_URL=${{ secrets.BACKEND_FRONTEND_URL }}" >> ./backend/.env

      # ============================
      # CREAR .ENV DEL FRONTEND
      # ============================
      - name: Crear archivo .env para frontend
        run: |
          echo "VITE_BACKEND_URL=${{ secrets.FRONTEND_BACKEND_URL }}" >> ./frontend/.env

      # ============================
      # INSTALAR DEPENDENCIAS BACKEND
      # ============================
      - name: Instalar dependencias backend
        working-directory: ./backend
        run: npm install

      # ============================
      # LINTER
      # ============================
      - name: Validar sintaxis backend
        working-directory: ./backend
        run: npm run lint || echo "Sin linter configurado"

      # ============================
      # DOCKER COMPOSE BUILD
      # ============================
      - name: Construir contenedores Docker
        run: docker compose build

      # ============================
      # DOCKER COMPOSE UP
      # ============================
      - name: Levantar servicios y verificar estado
        run: docker compose up -d

      # ============================
      # HEALTH CHECK DEL BACKEND
      # ============================
      - name: Probar que el backend responde (health check)
        run: |
          sleep 8
          curl --fail http://localhost:4000 || exit 1
